---
name: Implement SerialWorker.read_loop() with non-blocking reads
status: open
created: 2025-12-24T03:41:21Z
updated: 2025-12-24T03:41:21Z
github: https://github.com/junyoulin641/CCPM/issues/19
depends_on: [18]
parallel: false
conflicts_with: []
---

# Task: Implement SerialWorker.read_loop() with non-blocking reads

## Description
Implement the continuous read loop in the SerialWorker thread that performs non-blocking reads from the serial port. The loop should use timeout-based reads, check for available data, decode incoming bytes as UTF-8, and emit the dataReceived signal to the main UI thread. This is the core RX (receive) functionality of the UART widget.

## Acceptance Criteria
- [ ] `read_loop()` method implemented in SerialWorker class
- [ ] Loop runs while `self.running` flag is True
- [ ] Uses timeout-based non-blocking reads (timeout=0.1s)
- [ ] Checks `in_waiting` property before reading
- [ ] Decodes bytes as UTF-8 with `errors='replace'` for invalid characters
- [ ] Handles different line ending styles (CR, LF, CRLF)
- [ ] Emits `dataReceived` signal with decoded string data
- [ ] Loop exits cleanly when `running` flag is set to False

## Technical Details
**Implementation approach:**
- Add `read_loop()` method to SerialWorker class
- Main loop structure:
  ```python
  while self.running:
      if self.serial_port and self.serial_port.is_open:
          if self.serial_port.in_waiting:
              data = self.serial_port.read(self.serial_port.in_waiting)
              decoded = data.decode('utf-8', errors='replace')
              self.dataReceived.emit(decoded)
      time.sleep(0.01)  # Small delay to prevent CPU spinning
  ```
- Use timeout=0.1 on serial port to prevent blocking
- Handle `SerialException` gracefully during read operations

**Key considerations:**
- Non-blocking design: timeout prevents thread hanging
- UTF-8 decoding with error replacement: handles binary/malformed data
- Line endings: emit raw data, let UI handle line splitting/display
- CPU efficiency: small sleep prevents busy-waiting
- Thread safety: only emit signals, don't modify UI directly

**Code locations/files affected:**
- `uart_widget.py` - SerialWorker class, read_loop() method

## Dependencies
- [ ] Task 18 completed (SerialWorker.connectPort() implemented)
- [ ] pyserial library installed
- [ ] SerialWorker signals defined (dataReceived)

## Effort Estimate
- Size: M
- Hours: 2.5 hours
- Parallel: false (depends on task 18)

## Definition of Done
- [ ] Code implemented
- [ ] read_loop() runs in worker thread without blocking
- [ ] Received data successfully emitted via signal
- [ ] No data loss or buffer overflow
- [ ] Thread exits cleanly on disconnect
