---
name: Implement SerialWorker.connectPort() with error handling
status: open
created: 2025-12-24T03:41:21Z
updated: 2025-12-24T03:41:21Z
github: https://github.com/junyoulin641/CCPM/issues/18
depends_on: [10, 11]
parallel: false
conflicts_with: []
---

# Task: Implement SerialWorker.connectPort() with error handling

## Description
Implement the `connectPort()` slot in the SerialWorker class to open a serial port connection using PySerial. Handle all common connection errors (port not found, permission denied, port already in use) and emit appropriate signals for success and failure states.

## Acceptance Criteria
- [ ] `connectPort(port, baudrate, databits, parity, stopbits)` slot implemented
- [ ] Opens `serial.Serial` with correct parameters
- [ ] Emits `statusChanged("connected")` signal on successful connection
- [ ] Emits `errorOccurred(error_message)` signal on failure
- [ ] Handles SerialException and subclasses
- [ ] Handles common error scenarios: port not found, permission denied, port in use
- [ ] Stores serial port object for later use (reading/writing)
- [ ] Connection can be verified (port.is_open check)

## Technical Details
**Implementation approach:**
- Add `@pyqtSlot` decorator for connectPort method
- Accept parameters: port (str), baudrate (int), databits (int), parity (str), stopbits (float)
- Create `serial.Serial` object with provided parameters
- Set timeout for read operations (e.g., 0.1 seconds)
- Catch `serial.SerialException` and emit errorOccurred signal
- Emit statusChanged("connected") on success
- Store serial port reference in `self.serial_port`

**Key considerations:**
- PySerial parameter mapping:
  - databits: serial.FIVEBITS, SIXBITS, SEVENBITS, EIGHTBITS
  - parity: serial.PARITY_NONE, PARITY_EVEN, PARITY_ODD, PARITY_MARK, PARITY_SPACE
  - stopbits: serial.STOPBITS_ONE, STOPBITS_ONE_POINT_FIVE, STOPBITS_TWO
- Common errors to handle:
  - `SerialException: could not open port` → Port not found or invalid
  - `SerialException: [Errno 13] Permission denied` → Insufficient permissions
  - `SerialException: [Errno 16] Device or resource busy` → Port already open
- Set reasonable timeout (0.1s) to prevent blocking
- Close existing connection if connectPort called while already connected

**Code locations/files affected:**
- Modify: `uart_widget.py` (SerialWorker class from task 10)
- Add method: `connectPort(port, baudrate, databits, parity, stopbits)`
- Import: `import serial` (already added in task 11)

**Example implementation:**
```python
@pyqtSlot(str, int, int, str, float)
def connectPort(self, port, baudrate, databits, parity, stopbits):
    """Open serial port connection with specified parameters."""
    try:
        # Close existing connection if any
        if self.serial_port and self.serial_port.is_open:
            self.serial_port.close()

        # Map UI parameters to PySerial constants
        databits_map = {5: serial.FIVEBITS, 6: serial.SIXBITS,
                       7: serial.SEVENBITS, 8: serial.EIGHTBITS}
        parity_map = {'None': serial.PARITY_NONE, 'Even': serial.PARITY_EVEN,
                     'Odd': serial.PARITY_ODD, 'Mark': serial.PARITY_MARK,
                     'Space': serial.PARITY_SPACE}
        stopbits_map = {1: serial.STOPBITS_ONE, 1.5: serial.STOPBITS_ONE_POINT_FIVE,
                       2: serial.STOPBITS_TWO}

        # Create serial connection
        self.serial_port = serial.Serial(
            port=port,
            baudrate=baudrate,
            bytesize=databits_map.get(databits, serial.EIGHTBITS),
            parity=parity_map.get(parity, serial.PARITY_NONE),
            stopbits=stopbits_map.get(stopbits, serial.STOPBITS_ONE),
            timeout=0.1
        )

        self.statusChanged.emit("connected")

    except serial.SerialException as e:
        error_msg = f"Failed to open port {port}: {str(e)}"
        self.errorOccurred.emit(error_msg)
    except Exception as e:
        error_msg = f"Unexpected error: {str(e)}"
        self.errorOccurred.emit(error_msg)
```

## Dependencies
- [ ] Task 10 completed (SerialWorker class and signals exist)
- [ ] Task 11 completed (PySerial installed and imported)
- [ ] Python 3.10+ with PySerial library

## Effort Estimate
- Size: M
- Hours: 2 hours
- Parallel: false (depends on tasks 10 and 11)

## Definition of Done
- [ ] Code implemented
- [ ] Successfully opens serial port with correct parameters
- [ ] Emits statusChanged signal on success
- [ ] Emits errorOccurred signal with descriptive message on failure
- [ ] Handles all common error scenarios gracefully
- [ ] Connection state verifiable via serial_port.is_open
- [ ] No resource leaks (ports closed properly on errors)
- [ ] Tested with valid and invalid port names
