---
name: Implement capped message buffer (deque)
status: open
created: 2025-12-24T03:41:21Z
updated: 2025-12-24T03:41:21Z
github: https://github.com/junyoulin641/CCPM/issues/23
depends_on: [9]
parallel: true
conflicts_with: []
---

# Task: Implement capped message buffer (deque)

## Description
Create an in-memory message buffer using Python's `collections.deque` with a maximum length of 1000 entries. Each entry stores a message with metadata (direction, timestamp, payload). This buffer enables efficient message history management, prevents unbounded memory growth, and supports future features like message filtering and export.

## Acceptance Criteria
- [ ] Define MessageEntry structure (dict or dataclass) with fields: direction, timestamp, payload
- [ ] Create `deque(maxlen=1000)` instance in UARTWidget class
- [ ] Add messages to buffer on RX (dataReceived signal)
- [ ] Add messages to buffer on TX (sendData call)
- [ ] Buffer automatically drops oldest entries when exceeding 1000
- [ ] Timestamp captured at message receipt/send time
- [ ] Direction field distinguishes RX vs TX messages

## Technical Details
**Implementation approach:**
- Define message structure (using dict or dataclass):
  ```python
  from collections import deque
  from datetime import datetime

  # In UARTWidget.__init__():
  self.message_buffer = deque(maxlen=1000)

  # Message structure (option 1 - dict):
  message = {
      'direction': 'RX',  # or 'TX'
      'timestamp': datetime.now(),
      'payload': "message content"
  }

  # Add to buffer:
  self.message_buffer.append(message)
  ```
- Add to buffer in `display_message()` handler (RX direction)
- Add to buffer in `on_send_clicked()` handler (TX direction)
- Use `datetime.now()` for timestamp

**Key considerations:**
- deque(maxlen=1000) automatically evicts oldest: FIFO behavior
- Efficient: O(1) append and pop operations
- Memory bounded: 1000 messages prevents runaway growth
- Timestamp precision: millisecond-level for debugging
- Direction field: enables future filtering (show only RX, only TX)
- Payload as string: already decoded from bytes

**Code locations/files affected:**
- `uart_widget.py` - UARTWidget class, message_buffer attribute
- `uart_widget.py` - display_message() and on_send_clicked() methods

## Dependencies
- [ ] Task 9 completed (uart_widget.py module structure)
- [ ] collections.deque imported

## Effort Estimate
- Size: S
- Hours: 1 hour
- Parallel: true (can implement independently of serial logic)

## Definition of Done
- [ ] Code implemented
- [ ] MessageEntry structure defined
- [ ] deque(maxlen=1000) created and used
- [ ] Messages added on both RX and TX
- [ ] Buffer correctly caps at 1000 entries
- [ ] Timestamps accurately captured
