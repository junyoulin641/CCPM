---
name: Implement SerialWorker.disconnectPort() with resource cleanup
status: open
created: 2025-12-24T03:41:21Z
updated: 2025-12-24T03:41:21Z
github: https://github.com/junyoulin641/CCPM/issues/21
depends_on: [18]
parallel: false
conflicts_with: []
---

# Task: Implement SerialWorker.disconnectPort() with resource cleanup

## Description
Implement the disconnectPort() slot in the SerialWorker class to cleanly stop the read loop, close the serial port, release resources, and emit status signals. This ensures proper cleanup when the user clicks the Disconnect button or the application closes, preventing port lock issues and resource leaks.

## Acceptance Criteria
- [ ] `disconnectPort()` slot implemented with `@pyqtSlot()` decorator
- [ ] Sets `self.running` flag to False to stop read loop
- [ ] Closes serial port handle using `close()`
- [ ] Clears port reference (sets to None)
- [ ] Emits `portDisconnected` signal to notify UI
- [ ] Emits `statusChanged` signal with "Disconnected" message
- [ ] Handles case where port is already closed (no error)
- [ ] Ensures thread terminates cleanly

## Technical Details
**Implementation approach:**
- Add `@pyqtSlot()` decorated method to SerialWorker:
  ```python
  @pyqtSlot()
  def disconnectPort(self):
      self.running = False  # Stop read loop
      if self.serial_port and self.serial_port.is_open:
          self.serial_port.close()
      self.serial_port = None
      self.portDisconnected.emit()
      self.statusChanged.emit("Disconnected")
  ```
- Set `running` flag first to exit read loop gracefully
- Close port only if it exists and is open
- Null reference to prevent accidental use after disconnect

**Key considerations:**
- Order matters: stop loop before closing port to prevent read errors
- Graceful shutdown: don't raise exceptions if port already closed
- Signal emissions: notify UI of state change
- Resource safety: ensure no file descriptor leaks
- Thread lifecycle: worker thread should exit after disconnect

**Code locations/files affected:**
- `uart_widget.py` - SerialWorker class, disconnectPort() method

## Dependencies
- [ ] Task 18 completed (SerialWorker.connectPort() implemented)
- [ ] SerialWorker signals defined (portDisconnected, statusChanged)
- [ ] Read loop checks `self.running` flag

## Effort Estimate
- Size: S
- Hours: 1 hour
- Parallel: false (depends on task 18)

## Definition of Done
- [ ] Code implemented
- [ ] disconnectPort() cleanly stops read loop
- [ ] Serial port closed and resources released
- [ ] Status signals emitted correctly
- [ ] No errors when called multiple times
- [ ] Thread exits without hanging
