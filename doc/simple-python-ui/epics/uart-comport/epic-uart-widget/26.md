---
name: Implement connection error handling
status: open
created: 2025-12-24T03:41:21Z
updated: 2025-12-24T03:41:21Z
github: https://github.com/junyoulin641/CCPM/issues/26
depends_on: [18]
parallel: false
conflicts_with: []
---

# Task: Implement connection error handling

## Description
Implement comprehensive error handling for serial port connection failures in the SerialWorker.connectPort() method. Map specific SerialException types to user-friendly error messages and display them in the UI status label. This prevents confusing error dialogs and provides actionable feedback when connection fails (port not found, permission denied, port already in use).

## Acceptance Criteria
- [ ] Catch `serial.SerialException` in connectPort() method
- [ ] Detect and handle "Port not found" errors (invalid port name)
- [ ] Detect and handle "Permission denied" errors (Linux/macOS)
- [ ] Detect and handle "Port already open" errors (port in use)
- [ ] Emit `statusChanged` signal with user-friendly error message
- [ ] Emit `portDisconnected` signal on error (reset UI state)
- [ ] No unhandled exceptions or crashes on connection failure
- [ ] Error messages are clear and actionable

## Technical Details
**Implementation approach:**
- Wrap connectPort() serial port open with try/except:
  ```python
  @pyqtSlot(str, int, int, str, str, str)
  def connectPort(self, port, baudrate, databits, parity, stopbits, flowcontrol):
      try:
          self.serial_port = serial.Serial(
              port=port,
              baudrate=baudrate,
              # ... other params
          )
          self.portConnected.emit()
          self.statusChanged.emit(f"Connected to {port}")
          # Start read loop
      except serial.SerialException as e:
          error_msg = self._map_serial_error(e)
          self.statusChanged.emit(error_msg)
          self.portDisconnected.emit()  # Reset UI

  def _map_serial_error(self, exception):
      error_str = str(exception).lower()
      if 'could not open port' in error_str or 'filenotfound' in error_str:
          return "Error: Port not found. Check connection and try again."
      elif 'permission denied' in error_str or 'access denied' in error_str:
          return "Error: Permission denied. Try running with sudo (Linux/macOS)."
      elif 'port already open' in error_str or 'resource busy' in error_str:
          return "Error: Port already in use. Close other applications."
      else:
          return f"Connection error: {str(exception)}"
  ```

**Key considerations:**
- SerialException messages vary by OS and pyserial version
- Case-insensitive string matching for error detection
- Fallback message for unknown errors (show raw exception)
- Emit portDisconnected on error to reset UI buttons
- Status label displays error for user visibility
- No popup dialogs: keep UI lightweight

**Code locations/files affected:**
- `uart_widget.py` - SerialWorker.connectPort() method
- `uart_widget.py` - SerialWorker._map_serial_error() helper method

## Dependencies
- [ ] Task 18 completed (SerialWorker.connectPort() implemented)
- [ ] pyserial library installed
- [ ] SerialWorker signals defined (statusChanged, portDisconnected)

## Effort Estimate
- Size: M
- Hours: 1.5 hours
- Parallel: false (depends on task 18)

## Definition of Done
- [ ] Code implemented
- [ ] All common error types handled gracefully
- [ ] User-friendly error messages displayed
- [ ] No crashes on connection failure
- [ ] UI state resets correctly on error
- [ ] Tested with common error scenarios (missing port, permission issues)
